---
title: "Untitled"
output: html_document
date: '2022-05-21'
editor_options: 
  chunk_output_type: console
---

```{r}
https://stackoverflow.com/questions/59975512/nans-produced-warning-when-calculating-absolute-ec50-values-with-drc-package

https://stackoverflow.com/questions/68345031/error-in-plotting-dose-response-curve-in-ggplot-with-drc-package?rq=1

http://www.darrenkoppel.com/2020/09/04/dose-response-modelling-and-model-selection-in-r/
  
https://alvesks.github.io/ec50estimator/articles/how_to_use.html
```


```{r setup, include=FALSE}
pacman::p_load(tidyverse, pliman, drc)
```


```{r}
setwd(here::here("exp_pics"))
# getwd()
# list.files()
az <- image_import("az@0_0001.png")
dpi(az)
back <- pick_palette(az)
fore <- pick_palette(az)
```


```{r}
res_az <- analyze_objects(az,
                background = back,
                foreground = fore,
                watershed = FALSE)

az_0.1 <- get_measures(res_az)
plot_measures(az_0.1, measure = "circularity", col = "red")
plot_measures(az_0.1, col = "black", measure = "area", size = 1.5)

# az_0.1 <- as_tibble(az_0.1) %>% 
#   filter(circularity>.75)
# az_0.1
```

```{r}
list_res <- analyze_objects(pattern = "az@", 
                            show_image = T,
                            background = back,
                            foreground = fore,
                            watershed = F)
az_res <- list_res[["results"]] %>% 
  separate(img, c("ai", "dose"), sep ="@") %>% 
    mutate(dose= str_replace_all(dose, "_", ".") %>% 
           as.numeric) %>% 
  mutate(dose = recode(dose, `0.0001`=0)) %>% 
  dplyr::select(ai, dose, area)
az_res  
```

```{r}
az_res %>% 
  ggplot()+ 
  aes(dose, area) +
  geom_point()+
  stat_summary(fun = mean, color = "red", geom = "line", aes(group = 1)) 
```

# MODEL 

```{r}
model<- drm(area~dose, data=az_res, fct=LL.4(names = c("Slope", "Lower Limit", "Upper Limit", "ED50")))
plot(model, type="all")
```

```{r}
summary(model)
ED(model, respLev = 50, interval="delta", type = "absolute") 
ED(gro.LL.3, respLev = c(50), type = "relative") # this works fine
```

